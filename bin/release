#!/bin/sh
set -e

echo
read -p "This script will cut a new SDK release and will overwrite any unstaged changes. Are you sure? [Y/n] " -n 1 -r
echo
echo
if [[ $REPLY =~ ^[Yy]$ ]]
then
  # We want to always run this script with the pwd as the repo root. The
  # following line changes to the directory of this script. The line after moves
  # to its parent directory, which is the repo root.
  # https://stackoverflow.com/a/16349776
  cd "${0%/*}"
  cd ..

  # Rebase master on top of any documentation hotfixes that may have been
  # pushed to the docs branch since the last release
  git checkout docs
  git pull --rebase origin docs
  git checkout master
  git rebase docs

  # Interactively increment the version number and push a new tag
  yarn version
  npx auto-changelog --unreleased
  git add CHANGELOG.md
  git commit -m 'feature: update changelog'
  git push origin master --follow-tags -f

  # Freshly-deploy documentation with the latest changes
  git branch -D docs
  git checkout -b docs
  git push origin docs -f
  git checkout master
fi
